<!doctype html>
<html lang="es">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>User Location</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  </head>

  <body>
    <main class="container">
      <p id="info" class="info">
        <img src="./img/logoA.png" alt="Logo de organización" id="logo">
      </p>
      <div id="map" class="map"></div>
      <div id="dialog-content">
        <img width="50%" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iNzUycHQiIGhlaWdodD0iNzUycHQiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDc1MiA3NTIiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiA8cGF0aCBkPSJtMzc2IDU4OS44NGMxMTcuOTEgMCAyMTMuODQtOTUuOTI2IDIxMy44NC0yMTMuODQgMC0xMTcuOTEtOTUuOTMtMjEzLjgzLTIxMy44NC0yMTMuODMtMTE3LjkxIDAtMjEzLjgzIDk1LjkyNi0yMTMuODMgMjEzLjgzczk1LjkyMiAyMTMuODQgMjEzLjgzIDIxMy44NHptLTEyMi4wOS02Ny4yMjNjMy44MjQyLTQ3LjI3MyAzOC4xNzYtNjUuMTM3IDEyMi4wOS02NS4xMzcgODMuOTE0IDAgMTE4LjI4IDE3Ljg1NSAxMjIuMDkgNjUuMTI5LTMzLjEyMSAyNy42MjktNzUuNjkxIDQ0LjI4OS0xMjIuMSA0NC4yODktNDYuNDAyIDAtODguOTczLTE2LjY1Ni0xMjIuMDktNDQuMjgxem01My45MzgtMTU2LjIzYzAtMzcuNTgyIDMwLjU3NC02OC4xNTIgNjguMTU2LTY4LjE1MnM2OC4xNTYgMzAuNTc0IDY4LjE1NiA2OC4xNTJjMCAzNy41ODItMzAuNTc0IDY4LjE1Ni02OC4xNTYgNjguMTU2LTM3LjU4Mi0wLjAwMzkwNy02OC4xNTYtMzAuNTc0LTY4LjE1Ni02OC4xNTZ6bTY4LjE1Mi0xODEuMjhjMTA1LjI2IDAgMTkwLjkgODUuNjMzIDE5MC45IDE5MC44OSAwIDQ4LjkzLTE4LjUyMyA5My41OTQtNDguODk4IDEyNy40MS0xMS4yMjctNDMuOTY1LTQ4Ljg5NS01OS44ODctODUuNjI5LTY1LjYxNyAyMS4xMDUtMTYuNjk1IDM0LjcxNS00Mi40NzMgMzQuNzE1LTcxLjQxIDAtNTAuMjIzLTQwLjg2My05MS4wODYtOTEuMDg2LTkxLjA4NnMtOTEuMDg2IDQwLjg2My05MS4wODYgOTEuMDg2YzAgMjguOTQxIDEzLjYwNSA1NC43MTUgMzQuNzE1IDcxLjQxLTM2LjczNCA1LjczNDQtNzQuMzk4IDIxLjY0OC04NS42MjkgNjUuNjI1LTMwLjM3NS0zMy44Mi00OC44OTgtNzguNDg4LTQ4Ljg5OC0xMjcuNDIgMC0xMDUuMjcgODUuNjQxLTE5MC45IDE5MC44OS0xOTAuOXoiLz4KPC9zdmc+Cg==" alt="">
        <h4 id="target-name"></h4>
        <p>
          Esta es una descripciónesta es una descripción esta es una descripción esta es una descripción.
        </p>
      </div>
    </main>
    <script>
      const CIRCLE_RADIO = 300;
      const TIME_REFRESH = 500; // 30000

      const BURGLARS = [ /* Loaded by API  */
        [{lat: 13.6977923, lng: -89.1911526}, "Objetivo: Nombre A"],
        [{lat: 13.6966823, lng: -89.1902526}, "Objetivo: Nombre B"],
      ];

      const createMap = ({lat, lng}) => {
        return new google.maps.Map(document.getElementById('map'), {
          center: {lat, lng},
          zoom: 15
        });
      };

      const createMarker = ({map, position}) => {
        return new google.maps.Marker({map, position});
      };

      const trackLocation = ({onSuccess, onError = () => { }}) => {
        if ('geolocation' in navigator === false) {
          return onError(new Error('Geolocation is not supported by your browser.'));
        }

        return navigator.geolocation.watchPosition(onSuccess, onError, {
          enableHighAccuracy: true,

          timeout: TIME_REFRESH,
          maximumAge: 0
        });
      };

      const getPositionErrorMessage = code => {
        switch (code) {
          case 1:
            return 'Permission denied.';
          case 2:
            return 'Position unavailable.';
          case 3:
            return 'Timeout reached.';
        }
      }

      function viewPoinerInfo(i){
        let title = document.getElementById('target-name');
        title.innerHTML = BURGLARS[i][1];
        Fancybox.show([{src: "#dialog-content", type: "inline"}]);
      }

      function init() {
        const initialPosition = {lat: 59.30, lng: 17.70};
        const map = createMap(initialPosition);
        const marker = createMarker({map, position: initialPosition});
        const $info = document.getElementById('info');
        let userLocation;

        let watchId = trackLocation({
          onSuccess: ({coords: {latitude: lat, longitude: lng}}) => {
            marker.setPosition({lat, lng});
            userLocation = {lat, lng};
            map.panTo({lat, lng});
            // $info.appendChild( `Lat: ${lat.toFixed(5)} Lng: ${lng.toFixed(5)}` );
            // $info.classList.remove('error');

            cityCircle = new google.maps.Circle({
              strokeColor: "#FF0000",
              strokeOpacity: 0.8,
              strokeWeight: 2,
              fillColor: "transparent",
              fillOpacity: 0.35,
              map,
              center: userLocation,
              radius: CIRCLE_RADIO
            });

            /* Targets */
            let image = "./img/ladron.png";

            BURGLARS.filter(function (elem, i) {

              // let location = { lat: elem[0].lat, lng: elem[0].lng };
              let location = {lat: userLocation.lat + ((i / Math.random() / 1779)), lng: userLocation.lng + ((i / Math.random() / 1347))};

              let infowindow = new google.maps.InfoWindow({
                content: "<div class=infowindow><h1>Leeds</h1><p>Population: 715,402</p></div>"
              });
              pointer = new google.maps.Marker({
                position: location,
                map,
                title: elem[1],
                icon: image,
                content: infowindow,
                animation: google.maps.Animation.DROP,
              });

              pointer.addListener("click", () => {
                viewPoinerInfo(i)
              });
            });

          },
          onError: err => {
            console.log($info);
            $info.textContent = `Error: ${err.message || getPositionErrorMessage(err.code)}`;
            $info.classList.add('error');
          }
        });
      }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAc_Iu53k7S0cAx2xSx3kksMVUwHta30aU&callback=init"></script>
    <style>
      #dialog-content{
        display: none;
        max-width: 400px;
      }
      html {
        font-family: sans-serif;
        line-height: 1.15;
        height: 100%;
      }

      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
        color: #1a1a1a;
        text-align: left;
        height: 100%;
        background-color: #fff;
      }

      .container {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .map {
        flex: 1;
        background: #f0f0f0;
      }

      .info {
        text-align: center;
        padding: 1rem;
        margin: 0;
      }

      .info.error {
        color: #fff;
        background: #dc3545;
      }
      #logo{max-width: 100px; margin: 5px;}
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.css" />
    <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.js"></script>
  </body>

</html>
